<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/patient/patient-dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>Upcoming Appointments</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="loading-spinner">
    <ion-spinner name="crescent"></ion-spinner>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="error-message">
    {{ errorMessage }}
  </div>

  <!-- Upcoming Appointments -->
  <div class="section" *ngIf="!isLoading">
    <h2>Upcoming Appointments</h2>

    <!-- Confirmed -->
    <ion-accordion-group>
      <ion-accordion value="confirmed">
        <ion-item slot="header">
          <ion-label>Confirmed ({{ confirmedAppointments.length }})</ion-label>
        </ion-item>
        <div slot="content">
          <ion-list *ngIf="confirmedAppointments.length > 0; else noConfirmed">
            <ion-item *ngFor="let appt of confirmedAppointments">
              <ion-label>
                <h3>{{ appt.doctorName }}</h3>
                <p>{{ appt.date | date: 'medium' }}</p>
                <p>Reason: {{ appt.reason }}</p>
                <p>Status: {{ appt.status }}</p>
                <!-- Document Upload -->
                <input
                  type="file"
                  #fileInput
                  (change)="uploadDocument($event, appt.id, appt.doctorId)"
                  style="display: none"
                />
                <ion-button
                  [routerLink]="['/patient/appointment-details']"
                  [queryParams]="{ appointmentId: appt.id }"
                > Redirect
                </ion-button>
                <ion-button
                  size="small"
                  (click)="fileInput.click()"
                  [disabled]="isUploading[appt.id]"
                >
                  {{ isUploading[appt.id] ? 'Uploading...' : 'Upload Document' }}
                </ion-button>
                <!-- Document Links -->
                <div *ngIf="documents[appt.id] && documents[appt.id].length > 0">
                  <p>Documents:</p>
                  <a
                    *ngFor="let doc of documents[appt.id]"
                    [routerLink]="['/patient/appointment-details']"
                    [queryParams]="{ appointmentId: appt.id }"
                  >
                    {{ doc.filename }} ({{ doc.status }})
                  </a>
                </div>
              </ion-label>
            </ion-item>
          </ion-list>
          <ng-template #noConfirmed>
            <ion-item>
              <ion-label>No confirmed upcoming appointments.</ion-label>
            </ion-item>
          </ng-template>
        </div>
      </ion-accordion>
    </ion-accordion-group>

    <!-- Pending -->
    <ion-accordion-group>
      <ion-accordion value="pending">
        <ion-item slot="header">
          <ion-label>Pending ({{ pendingAppointments.length }})</ion-label>
        </ion-item>
        <div slot="content">
          <ion-list *ngIf="pendingAppointments.length > 0; else noPending">
            <ion-item *ngFor="let appt of pendingAppointments">
              <ion-label>
                <h3>{{ appt.doctorName }}</h3>
                <p>{{ appt.date | date: 'medium' }}</p>
                <p>Reason: {{ appt.reason }}</p>
                <p>Status: {{ appt.status }}</p>
              </ion-label>
            </ion-item>
          </ion-list>
          <ng-template #noPending>
            <ion-item>
              <ion-label>No pending upcoming appointments.</ion-label>
            </ion-item>
          </ng-template>
        </div>
      </ion-accordion>
    </ion-accordion-group>
  </div>
</ion-content>

<style>
  .loading-spinner {
    text-align: center;
    padding: 20px;
  }

  .error-message {
    color: red;
    text-align: center;
    padding: 20px;
  }

  .section {
    margin-bottom: 30px;
  }

  h2 {
    font-size: 1.5em;
    margin-bottom: 10px;
  }

  ion-accordion-group {
    margin-bottom: 15px;
  }

  ion-item {
    --padding-start: 10px;
    --padding-end: 10px;
  }

  ion-label p {
    margin: 5px 0;
  }
</style>
